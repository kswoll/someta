<!--
GENERATED FILE - DO NOT EDIT
This file was generated by [MarkdownSnippets](https://github.com/SimonCropp/MarkdownSnippets).
Source File: /Someta.Docs/Samples/ObservableAsProperty.source.md
To change this file edit the source file and then run MarkdownSnippets.
-->

# ObservableAsProperty

ReactiveUI provides a Fody extension (that I originally authored) the provides this functionality, but using this framework, you can just do it yourself, if you wanted. It provides a good example of the sort of extensions you can author with minimal fuss:

<!-- snippet: ObservableAsProperty -->
<a id='snippet-observableasproperty'></a>
```cs
[AttributeUsage(AttributeTargets.Property)]
public class ObservableAsPropertyAttribute : Attribute, IPropertyGetInterceptor, IStateExtensionPoint,
    IInstanceInitializer
{
    public InjectedField<object> Helper { get; set; } = default!;

    private Delegate? getValue;

    public void Initialize(object instance, MemberInfo member)
    {
        // Use expression trees to create a delegate of the form:
        //
        // Func<object, PropertyType> = x => ((ObservableAsPropertyHelper<PropertyType>)x).Value
        //
        // The first type parameter represents the ObservableAsPropertyHelper<> instance
        // The seconds type parameter is the property type of the property the attribute is associated with
        // You *could* just use simple reflection, but this solution is more performant
        var propertyInfo = (PropertyInfo)member;
        var observableAsPropertyHelperType = typeof(ObservableAsPropertyHelper<>).MakeGenericType(propertyInfo.PropertyType);
        var valueProperty = observableAsPropertyHelperType.GetProperty("Value")!;
        var instanceParameter = Expression.Parameter(typeof(object));
        var castedInstance = Expression.Convert(instanceParameter, observableAsPropertyHelperType);
        var body = Expression.MakeMemberAccess(castedInstance, valueProperty);
        var delegateType = typeof(Func<,>).MakeGenericType(typeof(object), propertyInfo.PropertyType);
        var lambda = Expression.Lambda(delegateType, body, instanceParameter);
        getValue = lambda.Compile();
    }

    public object? GetPropertyValue(PropertyInfo propertyInfo, object instance, Func<object> getter)
    {
        var helper = Helper.GetValue(instance);
        return getValue!.DynamicInvoke(helper);
    }
}
```
<sup><a href='/Someta.Docs/Source/Samples/ObservableAsPropertyAttribute.cs#L8-L43' title='Snippet source file'>snippet source</a> | <a href='#snippet-observableasproperty' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

Here's the equivalent implementation to ObservableAsPropertyExtensions: (**note**: this is a simplified example without all the overloads, but you could easily add the missing ones)

<!-- snippet: ObservableAsPropertyExtensions -->
<a id='snippet-observableaspropertyextensions'></a>
```cs
public static class ObservableAsPropertyExtensions
{
    public static ObservableAsPropertyHelper<TRet> ToPropertyEx<TObj, TRet>(this IObservable<TRet> @this, TObj source, Expression<Func<TObj, TRet>> property, bool deferSubscription = false, IScheduler? scheduler = null)
        where TObj : ReactiveObject
    {
        var result = @this.ToProperty(source, property, deferSubscription, scheduler);

        // Now assign the field
        var propertyInfo = property.GetPropertyInfo();
        var extensionPoint = propertyInfo.GetExtensionPoint<ObservableAsPropertyAttribute>();
        extensionPoint.Helper.SetValue(source, result);

        return result;
    }

    private static PropertyInfo GetPropertyInfo(this LambdaExpression expression)
    {
        var current = expression.Body;
        if (current is UnaryExpression unary)
        {
            current = unary.Operand;
        }

        var call = (MemberExpression)current;
        return (PropertyInfo)call.Member;
    }
}
```
<sup><a href='/Someta.Docs/Source/Samples/ObservableAsPropertyAttribute.cs#L45-L73' title='Snippet source file'>snippet source</a> | <a href='#snippet-observableaspropertyextensions' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->

Usage:

<!-- snippet: ObservableAsPropertyExample -->
<a id='snippet-observableaspropertyexample'></a>
```cs
[TestFixture]
public class ObservableAsPropertyTests
{
    [Test]
    public void ObservableAsPropertyExample()
    {
        var subject = new Subject<string>();
        var o = new TestClass();
        subject.ToPropertyEx(o, x => x.StringProperty);

        var initialValue = o.StringProperty;
        initialValue.ShouldBeNull();

        subject.OnNext("first value");

        var nextValue = o.StringProperty;
        nextValue.ShouldBe("first value");
    }

    public class TestClass : ReactiveObject
    {
        [ObservableAsProperty]
        public string? StringProperty { get; }
    }
}
```
<sup><a href='/Someta.Docs/Tests/Samples/ObservableAsPropertyTests.cs#L9-L35' title='Snippet source file'>snippet source</a> | <a href='#snippet-observableaspropertyexample' title='Start of snippet'>anchor</a></sup>
<!-- endSnippet -->
